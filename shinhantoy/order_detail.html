<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>주문 상세 페이지</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.3.min.js"
      integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
      crossorigin="anonymous"
    ></script>
    <script>
        const search = new URLSearchParams(location.search);//쿼리스트링을 받아올 수 있다.
        const pk = search.get('pk');
        let page = search.get('page');//현재 페이지
        if(!page){
          page=1;
        }
        function create(){
          $.ajax({
            type: "POST",
            url: "http://127.0.0.1:8000/api/order/comment",
            data: {
              order: pk,
              content: $("#content").val(),
            },
            beforeSend: function (xhr) {
              xhr.setRequestHeader("Authorization", "JWT " + $("#token").val());
            },
            success: (result) => {
              alert("댓글 업로드 됨");
              location.reload();
            },
          });
        }
    

        $(document).ready(function () {
          if (pk > 0) {
            $.get("http://127.0.0.1:8000/api/order/" + pk).then(
              (result) => {
                const keys = Object.keys(result);
                $("#info").html("");
                for (let i=0; i<keys.length; i++){
                  let key = keys[i];
                  $("#info").append(
                    $(`<li>${key}: ${result[key]}</li>`)
                  );
                }
              }
            );
            $.get(
              "http://127.0.0.1:8000/api/order/" + pk  + "/comment?page=" + page
            ).then((result) => {
              $("#comments").html("");

              for (let i = 0; i < result.results.length; i++) {
                const comment = result.results[i];

                $("#comments").append(
                  $(`<li class="list-group-item">
                          ${comment.content}<br><br>
                          ${comment.member_username} (${comment.tstamp})
                  </li>`)
                );
              }
            });
          }
        });
        function go_page(page){
            const search = new URLSearchParams(location.search);
            const pk = search.get('pk');
            window.location.href=`?pk=${pk}&page=${page}`;
        }
    </script>
</head>
<body>
  <div class="container">
      <ul id="info">
      </ul>
      <hr>
      <h5>댓글 쓰기</h5>
      <div class="form-group mb-3">
          <label for="token">토큰</label>
          <input type="text" class="form-control" id="token" name="token" />
      </div>
      <div class="mb-3">
          <label for="content" class="form-label">내용</label>
          <textarea class="form-control" id="content" name="content" rows="3"></textarea>
      </div>
      <button type="button" class="btn btn-primary" onclick="create()">댓글등록</button>
      <hr>
      <ul class="list-group list-group-flush" id="comments">
          <li class="list-group-item">댓글 내용입니다.<br><br></li>
      </ul>
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <li class="page-item"><a class="page-link" onclick="go_page(1)">1</a></li>
          <li class="page-item"><a class="page-link" onclick="go_page(2)">2</a></li>
          <li class="page-item"><a class="page-link" onclick="go_page(3)">3</a></li>
          <li class="page-item"><a class="page-link" onclick="go_page(4)">4</a></li>
          <li class="page-item"><a class="page-link" onclick="go_page(5)">5</a></li>
        </ul>
    </nav>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>
